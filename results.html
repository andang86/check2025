<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì œì¶œ ê²°ê³¼ í™•ì¸ (ê°€ë¡œ ë³´ê¸°)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            margin: 20px;
            background-color: #f4f4f9; 
        }
        h1 { 
            text-align: center; 
            color: #333;
        }
        .controls {
            text-align: right;
            margin-bottom: 20px;
            max-width: 95%;
            margin-left: auto;
            margin-right: auto;
        }
        button#download-btn {
            padding: 10px 20px;
            background-color: #1d6f42;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        button#download-btn:hover {
            background-color: #165934;
        }
        .table-container {
            width: 95%;
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥ */
            margin: 0 auto;
            border: 1px solid #ddd;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            white-space: nowrap; /* ì…€ ë‚´ìš© ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: center; 
            vertical-align: middle; 
        }
        th { 
            background-color: #f8f9fa; 
            font-weight: 600;
            position: sticky; /* ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” ê³ ì • */
            top: 0;
            z-index: 2;
        }
        .question-col { /* ì§ˆë¬¸ì´ ìˆëŠ” ì²« ë²ˆì§¸ ì—´ ìŠ¤íƒ€ì¼ */
            text-align: left;
            font-weight: bold;
            background-color: #f8f9fa;
            position: sticky; /* ìŠ¤í¬ë¡¤ ì‹œ ì²« ë²ˆì§¸ ì—´ ê³ ì • */
            left: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
    <h1>ì „ì²´ ì œì¶œ ê²°ê³¼</h1>

    <div class="controls">
        <button id="download-btn">ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ ğŸ“¥</button>
    </div>

    <div class="table-container">
        <table id="resultsTable">
            <thead>
                </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // ëª¨ë“  ì§ˆë¬¸ í•­ëª©ì˜ ëª©ë¡ (ë‚˜ì¤‘ì— í…Œì´ë¸” ìƒì„± ì‹œ ìˆœì„œëŒ€ë¡œ ì‚¬ìš©ë¨)
        const questions = {
            'check1_1': 'í­ì—¼ìœ¼ë¡œ ê¸‰ë°•í•œ ìœ„í—˜ ë°œìƒ ì‹œ ì‚¬ì—…ì£¼ ì‘ì—…ì¤‘ì§€',
            'check1_2': 'í­ì—¼ìœ¼ë¡œ ê¸‰ë°•í•œ ìœ„í—˜ ë°œìƒ ì‹œ ë…¸ë™ì ì‘ì—…ê±°ë¶€ê¶Œ ë³´ì¥',
            'check2_1': 'ëƒ‰ë°©Â·í†µí’ ìœ„í•œ ì ì ˆí•œ ì˜¨ë„Â·ìŠµë„ ì¡°ì ˆ ì¥ì¹˜ ì„¤ì¹˜ ë° ì‘ë™',
            'check2_2': 'ì‘ì—… ì‹œê°„ëŒ€ ì¡°ì •',
            'check2_3': 'ì ì ˆí•œ íœ´ì‹ ì‹œê°„ ë¶€ì—¬',
            'check3_1': 'ì£¼ëœ ì‘ì—… ì¥ì†Œì— ì˜¨ë„ê³„ ë˜ëŠ” ì˜¨Â·ìŠµë„ê³„ë¥¼ ìƒì‹œ ë¹„ì¹˜',
            'check4_1': 'ì˜¨ì—´ì§ˆí™˜ ì¦ìƒ ë° ì˜ˆë°© ë°©ë²•, ì‘ê¸‰ì¡°ì¹˜ ìš”ë ¹ ë“± êµìœ¡',
            'check5_1': 'ì‚¬ì—…ì¥ ì²´ê°ì˜¨ë„ ì¸¡ì • ë° ì¡°ì¹˜ ì‚¬í•­ ê¸°ë¡Â·ë³´ê´€',
            'check6_1': 'ì˜¨ì—´ì§ˆí™˜ ì˜ì‹¬ ì‹œ ëŒ€ì‘ ì¡°ì¹˜ ì—¬ë¶€',
            'check7_1': 'ì²´ê°ì˜¨ë„ 33â„ƒ ì´ìƒ ì‹œ ë§¤ 2ì‹œê°„ ë‚´ 20ë¶„ ì´ìƒ íœ´ì‹ ë¶€ì—¬',
            'check8_1': 'ë•€ì„ ë§ì´ í˜ë¦¬ëŠ” ì‘ì—… ì¥ì†Œì— ì†Œê¸ˆê³¼ ê¹¨ë—í•œ ë¬¼ ì œê³µ',
            'check9_1': 'íƒˆì˜ì‹œì„¤, ëª©ìš•ì‹œì„¤, ì„¸íƒì‹œì„¤ ë° ê±´ì¡°ì‹œì„¤ ì„¤ì¹˜',
            'check10_1': 'ê³ ì—´ ì‘ì—…ì‹œ ë°©ì—´ ì¥ê°‘, ë°©ì—´ë³µ ì§€ê¸‰',
            'check11_1': 'íœ´ê²Œì‹œì„¤(ì‰¼í„°) ì„¤ì¹˜',
            'check11_2': 'í•˜ì²­ ë…¸ë™ì íœ´ê²Œì‹œì„¤ ì„¤ì¹˜ í˜¹ì€ ê³µë™ ì´ìš© ë³´ì¥',
            'check11_3': 'í¸ë¦¬í•˜ê³  ê°€ê¹Œìš´ ê³³ì— ì„¤ì¹˜',
            'check11_4': 'ì ì •í•œ ì˜¨ë„ (18â„ƒ-28â„ƒ) ìœ ì§€ ëƒ‰ë‚œë°© ê¸°ëŠ¥',
            'check11_5': 'ì ì •í•œ ìŠµë„ (50-55%) ìœ ì§€',
            'check11_6': 'ì¡°ëª… (100-200ëŸ­ìŠ¤) ìœ ì§€',
            'check11_7': 'ì°½ë¬¸ì„ í†µí•œ í™˜ê¸° ê°€ëŠ¥',
            'check11_8': 'ì˜ì ë“± ë¹„í’ˆ êµ¬ë¹„',
            'check11_9': 'ë¬¼, ì‹ìˆ˜ ì„¤ë¹„ êµ¬ë¹„',
            'check11_10': 'íœ´ê²Œì‹œì„¤ í‘œì§€ ì™¸ë¶€ ë¶€ì°©',
            'check11_11': 'íœ´ê²Œì‹œì„¤ ì²­ì†Œ, ê´€ë¦¬ ë‹´ë‹¹ì ì§€ì •',
            'check11_12': 'ë¬¼í’ˆë³´ê´€ ë“± íœ´ê²Œì‹œì„¤ ëª©ì  ì™¸ ìš©ë„ ì‚¬ìš© ê¸ˆì§€'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const password = sessionStorage.getItem('admin-auth');
            if (!password) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/admin.html';
                return;
            }

            try {
                const response = await fetch('/api/results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) throw new Error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
                const data = await response.json();
                
                renderTable(data);

            } catch (error) {
                console.error(error);
                alert('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        function renderTable(data) {
            const table = document.getElementById('resultsTable');
            table.innerHTML = ''; // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ë¹„ìš°ê¸°

            if (data.length === 0) {
                table.innerHTML = '<tbody><tr><td>ì œì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody>';
                return;
            }

            // --- 1. í—¤ë” ìƒì„± (ì§ˆë¬¸, ì§€íšŒëª…1, ì§€íšŒëª…2, ...) ---
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const questionHeader = document.createElement('th');
            questionHeader.className = 'question-col';
            questionHeader.textContent = 'ì ê²€ í•­ëª©';
            headerRow.appendChild(questionHeader);

            data.forEach(submission => {
                const th = document.createElement('th');
                th.textContent = submission.chapterName;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // --- 2. ë³¸ë¬¸ ìƒì„± (ì§ˆë¬¸ë³„ë¡œ í–‰ ìƒì„±) ---
            const tbody = document.createElement('tbody');
            Object.keys(questions).forEach(questionKey => {
                const questionText = questions[questionKey];
                const row = document.createElement('tr');
                
                const questionCell = document.createElement('td');
                questionCell.className = 'question-col';
                questionCell.textContent = questionText;
                row.appendChild(questionCell);

                // ê° ì œì¶œë¬¼ì— ëŒ€í•´ í•´ë‹¹ ì§ˆë¬¸ì˜ ë‹µë³€ ì°¾ê¸°
                data.forEach(submission => {
                    const answerCell = document.createElement('td');
                    const answer = submission.checklistData[questionKey] || 'ë¯¸ì„ íƒ';
                    answerCell.textContent = answer;
                    row.appendChild(answerCell);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
        }
        
        // --- 3. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ---
        document.getElementById('download-btn').addEventListener('click', () => {
            const table = document.getElementById('resultsTable');
            if (!table || table.rows.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í…Œì´ë¸” ë°ì´í„°ë¥¼ ì—‘ì…€ ì‹œíŠ¸ í˜•íƒœë¡œ ë³€í™˜
            const ws = XLSX.utils.table_to_sheet(table);
            
            // ì—‘ì…€ ì›Œí¬ë¶ ìƒì„± ë° ì‹œíŠ¸ ì¶”ê°€
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì œì¶œê²°ê³¼');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, `ì˜¨ì—´ì§ˆí™˜_ì ê²€ê²°ê³¼_${new Date().toLocaleDateString('ko-KR')}.xlsx`);
        });

    </script>
</body>
</html>
